{"version":3,"sources":["api/companies/company-all-coupons.service.js"],"names":["CompanyService","require","gmail","Companies","CompanyAllCoupons","CompanyParser","module","exports","CompanyAllCouponsService","call","companies","prototype","constructor","getIdsForAllPromotionalEmailBeforeNDay","accessToken","userId","day","options","labelIds","q","fields","LIST_Messages","addCompany","email","emailOriginValue","payload","headers","value","companyName","parseCompanyName","hasCompany","companyDomain","parseCompanyDomain","company","addCouponId","id","getCompany","getCompanies","getAllCompanies"],"mappings":";;;;;;;;AAAA;;;;AAIA,IAAIA,iBAAiBC,QAAQ,mBAAR,CAArB;AACA,IAAIC,QAAQD,QAAQ,uBAAR,CAAZ;AACA,IAAIE,YAAYF,QAAQ,oBAAR,CAAhB;AACA,IAAIG,oBAAoBH,QAAQ,8BAAR,CAAxB;AACA,IAAII,gBAAgBJ,QAAQ,kBAAR,CAApB;;AAEAK,OAAOC,OAAP,GAAiBC,wBAAjB;;AAEA,SAASA,wBAAT,GAAqC;;AAEpCR,iBAAeS,IAAf,CAAoB,IAApB;AACA,OAAKC,SAAL,GAAiB,IAAIP,SAAJ,EAAjB;AAEA;;AAEDK,yBAAyBG,SAAzB,GAAqC,sBAAcX,eAAeW,SAA7B,CAArC;AACAH,yBAAyBG,SAAzB,CAAmCC,WAAnC,GAAiDJ,wBAAjD;;AAEA;;;;;;AAMAA,yBAAyBG,SAAzB,CAAmCE,sCAAnC,GAA4E,UAASC,WAAT,EAAsBC,MAAtB,EAA8BC,GAA9B,EAAmC;AAC7G,MAAIC,UAAU;AACVF,YAASA,MADC;AAEVG,cAAU,CAAC,qBAAD,CAFA;AAGVC,uBAAiBH,GAAjB,MAHU;AAIVI,YAAQ;AAJE,GAAd;AAMA,SAAOlB,MAAMmB,aAAN,CAAoBJ,OAApB,EAA6BH,WAA7B,CAAP;AACD,CARD;;AAUA;;;AAGAN,yBAAyBG,SAAzB,CAAmCW,UAAnC,GAAgD,UAASC,KAAT,EAAgB;;AAE9D,MAAIC,mBAAmBD,MAAME,OAAN,CAAcC,OAAd,CAAsB,CAAtB,EAAyBC,KAAhD;AACA,MAAIC,cAAcvB,cAAcwB,gBAAd,CAA+BL,gBAA/B,CAAlB;;AAEA,MAAK,CAAC,KAAKd,SAAL,CAAeoB,UAAf,CAA0BF,WAA1B,CAAN,EAA+C;;AAE7C,QAAIG,gBAAgB1B,cAAc2B,kBAAd,CAAiCR,gBAAjC,CAApB;;AAEA,QAAIS,UAAU,IAAI7B,iBAAJ,CAAsBwB,WAAtB,EAAmCG,aAAnC,CAAd;AACAE,YAAQC,WAAR,CAAoBX,MAAML,QAA1B,EAAoCK,MAAMY,EAA1C;;AAEA,SAAKzB,SAAL,CAAeY,UAAf,CAA0BM,WAA1B,EAAuCK,OAAvC;AACD,GARD,MASK;AACH,QAAIA,UAAU,KAAKvB,SAAL,CAAe0B,UAAf,CAA0BR,WAA1B,CAAd;AACAK,YAAQC,WAAR,CAAoBX,MAAML,QAA1B,EAAoCK,MAAMY,EAA1C;AACD;AACF,CAlBD;;AAoBA;;;AAGA3B,yBAAyBG,SAAzB,CAAmC0B,YAAnC,GAAkD,YAAW;AAC5D,SAAO,KAAK3B,SAAL,CAAe4B,eAAf,EAAP;AACA,CAFD","file":"company-all-coupons.service.js","sourcesContent":["/**\n * Created by Carlos on 3/6/2017.\n */\n\nvar CompanyService = require('./company.service');\nvar gmail = require('../gmail/gmail-client');\nvar Companies = require('./companies.module');\nvar CompanyAllCoupons = require('./company-all-coupons.module');\nvar CompanyParser = require('./company-parser');\n\nmodule.exports = CompanyAllCouponsService;\n\nfunction CompanyAllCouponsService () {\n\n CompanyService.call(this);\n this.companies = new Companies();\n\n}\n\nCompanyAllCouponsService.prototype = Object.create(CompanyService.prototype);\nCompanyAllCouponsService.prototype.constructor = CompanyAllCouponsService;\n\n/**\n *  @param (String) accessToken\n *  @param {String} userId\n *  @param {String} day\n *  @return {Promise} messages[{id:string},]\n */\nCompanyAllCouponsService.prototype.getIdsForAllPromotionalEmailBeforeNDay = function(accessToken, userId, day) {\n  var options = {\n      userId : userId,\n      labelIds: ['CATEGORY_PROMOTIONS'],\n      q: `newer_than:${day}d`,\n      fields: 'messages(id)'\n    };\n  return gmail.LIST_Messages(options, accessToken);\n};\n\n/**\n * @param email { id, labelIds[], payload.headers[]}\n */\nCompanyAllCouponsService.prototype.addCompany = function(email) {\n\n  var emailOriginValue = email.payload.headers[0].value;\n  var companyName = CompanyParser.parseCompanyName(emailOriginValue);\n\n  if ( !this.companies.hasCompany(companyName) ) {\n\n    var companyDomain = CompanyParser.parseCompanyDomain(emailOriginValue);\n\n    var company = new CompanyAllCoupons(companyName, companyDomain);\n    company.addCouponId(email.labelIds, email.id);\n\n    this.companies.addCompany(companyName, company);\n  }\n  else {\n    var company = this.companies.getCompany(companyName);\n    company.addCouponId(email.labelIds, email.id);\n  }\n};\n\n/**\n * @return {Companies}\n */\nCompanyAllCouponsService.prototype.getCompanies = function() {\n return this.companies.getAllCompanies();\n};\n\n\n\n"]}